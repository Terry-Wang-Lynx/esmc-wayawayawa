# 工作文档：基于 ESM-C 的小样本蛋白质分类工具 (`classify` 模块)

## 1\. 项目概览与核心要求

### 1.1. 项目目标

开发一个高效、无提示（Prompt-free）的蛋白质序列二分类工具。该工具基于 **ESM-C (600M)** 模型，采用 **SETFIT** 双阶段微调策略，并要求输出结果具备 **ESM-Ezy** 论文中展示的、高辨识度的语义空间可视化效果。

### 1.2. 核心技术方法

1.  **小样本方法**：采用 **SETFIT** 框架（参考文献：arXiv:2209.11055v1）。
      * **阶段 I (对比预训练)**：对 ESM-C 编码器进行微调，使其学习区分正负序列对的语义空间。
      * **阶段 II (分类头训练)**：固定或微调 ESM-C 编码器，训练一个简单的分类头。
2.  **基座模型**：**ESM-C 600M** 模型。
3.  **可视化方法**：借鉴 **ESM-Ezy** (s41467-025-58521-y) 的数据可视化风格，要求降维（UMAP/t-SNE）后的不同类别序列聚类清晰、分离度高。

-----

## 2\. 文件结构与模块职责

所有文件必须存放在项目根目录下的 **`classify/`** 文件夹中。

```
.
├── classify/
│   ├── __init__.py             # 包初始化文件
│   ├── config.py               # ⚙️ 核心配置参数 (所有可调参数必须集中于此文件最前端)
│   ├── data_loader.py          # 💾 数据加载与样本生成模块
│   ├── model.py                # 🧠 模型架构定义模块
│   ├── utils.py                # 🛠️ 辅助工具（日志、检查点、降维可视化）
│   ├── stage1_pretrain.py      # 🚀 阶段 I：对比学习预训练脚本
│   ├── stage2_finetune.py      # 🚀 阶段 II：分类头训练脚本
│   ├── predict.py              # 🚀 最终推理/预测脚本
│   └── output/
│       ├── logs/               # 实时日志文件存放 (stage1_log.txt, stage2_log.txt, predict_log.txt)
│       ├── checkpoints/        # 模型检查点存放 (支持断点恢复)
│       └── visualizations/     # 降维可视化图片存放 (.png)
└── ... (项目其他文件)
```

-----

## 3\. 核心功能与实现规范

### 3.1. 数据输入规范

工具将读取以下四个 `.fasta` 文件，假定它们位于 `config.py` 定义的 `DATA_ROOT` 路径下：

| 文件名 | 描述 | 用途 |
| :--- | :--- | :--- |
| `train_mono.fasta` | 训练集：类别 1 序列 | 阶段 I/II 训练 |
| `train_di.fasta` | 训练集：类别 2 序列 | 阶段 I/II 训练 |
| `test_mono.fasta` | 测试集：类别 1 序列 | 阶段 I/II 评估与可视化 |
| `test_di.fasta` | 测试集：类别 2 序列 | 阶段 I/II 评估与可视化 |

### 3.2. 核心配置 (`classify/config.py`)

AI Agent 必须在 `config.py` 中以 Python 字典或常量的形式定义所有可调参数，并确保它们在文件最前端。

| 模块 | 参数名 | 描述 | 默认值示例 |
| :--- | :--- | :--- | :--- |
| 模型 | `ESMC_MODEL_NAME` | ESM-C 600M 的模型名称（用于加载）。 | `"esm_c_600m"` |
| 模型 | `EMBEDDING_DIM` | ESM-C 序列嵌入维度。 | `1280` |
| 阶段 I | `STAGE1_EPOCHS` | 对比预训练总轮数。 | `20` |
| 阶段 I | `LOG_INTERVAL_STEPS` | 训练 Loss 实时输出间隔（步数）。 | `50` |
| 阶段 I | `SAVE_CHECKPOINT_INTERVAL` | 检查点保存间隔（Epoch）。 | `5` |
| 阶段 I | `RESUME_FROM_CHECKPOINT` | 断点恢复的检查点路径（若为 `None` 则从头开始）。 | `None` |
| 阶段 II | `STAGE2_EPOCHS` | 分类头训练总轮数。 | `50` |
| 阶段 II | `FREEZE_BASE_MODEL` | **布尔值。** 是否冻结 ESM-C 编码器。 | `True` |
| 阶段 II | `UNFREEZE_LAST_N_LAYERS` | **整数。** 若不完全冻结，解冻 ESM-C 最后的 N 层（`0` 表示全部冻结）。 | `2` |
| 评估/可视化 | `VISUALIZATION_EPOCH_INTERVAL` | 降维语义空间图输出间隔（Epoch）。 | `10` |
| 评估/可视化 | `VISUALIZATION_METHOD` | 降维方法：`"UMAP"` 或 `"t-SNE"`。 | `"UMAP"` |

### 3.3. 模型定义 (`classify/model.py`)

1.  **Encoder 加载**：实现 ESM-C 600M 模型的加载逻辑。
2.  **Encoder 输出**：`forward_encoder` 方法应返回序列的语义嵌入（例如，CLS token 的向量或平均池化）。
3.  **分类头**：在编码器输出之上添加一个简单的线性分类层（例如：`Linear -> ReLU -> Dropout -> Linear(to 2 classes)`）。
4.  **冻结控制**：根据 `config.py` 中的 `FREEZE_BASE_MODEL` 和 `UNFREEZE_LAST_N_LAYERS` 参数，实现对 ESM-C 编码器层参数的精确控制，设置 `requires_grad` 属性。

### 3.4. 阶段 I 训练逻辑 (`classify/stage1_pretrain.py`)

1.  **数据处理**：`data_loader.py` 必须实现根据输入文件生成**正样本对**（目标标签 `1`）和**负样本对**（目标标签 `-1`）的逻辑。
2.  **损失函数**：使用对比损失函数（例如：`CosineEmbeddingLoss`），训练目标为：
      * **最小化** 正样本对（来自同一文件）嵌入间的距离。
      * **最大化** 负样本对（来自不同文件）嵌入间的距离。
3.  **实时输出**：
      * **日志**：实时将训练参数和 Loss 写入 `output/logs/stage1_log.txt`。
      * **恢复**：检查并实现从 `RESUME_FROM_CHECKPOINT` 恢复训练状态（模型权重和优化器状态）。
4.  **语义空间可视化（周期性）**：
      * 每隔 `VISUALIZATION_EPOCH_INTERVAL`，使用当前模型编码 `test_mono.fasta` 和 `test_di.fasta` 中的序列。
      * 调用 `utils.py` 中的降维绘图功能，生成并实时更新图片到 `output/visualizations/`。

### 3.5. 阶段 II 训练逻辑 (`classify/stage2_finetune.py`)

1.  **模型加载**：加载阶段 I 训练得到的 `stage1_final.pth` 中的 ESM-C 编码器权重。
2.  **训练集**：将 `train_mono.fasta` 和 `train_di.fasta` 中的序列及其对应的二分类标签（0 或 1）作为训练数据。
3.  **模型优化**：根据配置，仅优化分类头参数和/或解冻的 ESM-C 编码器层参数。
4.  **实时输出与评估**：
      * **日志**：实时输出训练 Loss 和准确率到 `output/logs/stage2_log.txt`。
      * **评估**：每隔 `EVAL_EPOCH_INTERVAL`，在测试集上进行一次准确率评估。
      * **语义空间可视化（周期性）**：每隔 `VISUALIZATION_EPOCH_INTERVAL`，对测试集进行降维可视化，图表应展示分类头训练后语义空间中更清晰的分界线。

### 3.6. 辅助工具 (`classify/utils.py`)

| 函数 | 职责 | 实时性/恢复性要求 |
| :--- | :--- | :--- |
| `log_message` | 实时日志记录 | 必须立即将带时间戳的消息追加写入指定日志文件。 |
| `save_checkpoint` | 保存检查点 | 必须保存模型状态、优化器状态和当前 Epoch，以支持断点恢复。 |
| `load_checkpoint` | 加载检查点 | 必须能够加载模型和优化器状态，并返回下一个开始的 Epoch 编号。 |
| `reduce_and_plot_embeddings` | **降维与绘图（核心）** | 必须使用 UMAP/t-SNE 对嵌入进行降维，并以 **ESM-Ezy 风格**绘制散点图。每次保存时，应先保存为临时文件再替换目标文件，确保文件始终是完整的最新版本。 |

### 3.7. 推理过程 (`classify/predict.py`)

1.  **模型加载**：加载最终训练完成的 `stage2_final.pth` 模型。
2.  **推理输入**：接受用户指定的 `.fasta` 文件（未分类序列）。
3.  **输出结果规范**：
      * **分类 FASTA**：生成一个新的 `.fasta` 文件，其中每条序列的描述信息（`>ID Description`）中必须包含预测的类别标签（例如：`Predicted_Class:Mono_Class`）。
      * **日志**：输出到 `output/logs/predict_log.txt`，记录每个序列的预测结果。
      * **预测可视化**：生成一个 2D 降维图，展示所有预测序列的嵌入分布，并以**预测的类别**进行颜色编码。